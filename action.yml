name: "Submodules Alternative"
description: "Adds/updates all repositories added by the Submodules Alternative workflow."
author: "Panquesito7"
branding:
  icon: git-pull-request
  color: purple
inputs:
  repos_filename:
    description: "The filename used to obtain the repository data (no file format is required)."
    required: true
    default: "repos"
  use_pr:
    description: "Whether to add/update repositories via a PR or direct push."
    required: true
    default: "true"
  branch_name:
    description: "The name of the branch to push to (only if `use_pr` is enabled)."
    required: false
    default: "repo-update"
  commit_message:
    description: "The commit/PR message to use when adding new repositories."
    required: false
    default: "Add repositories"
  commit_message_update:
    description: "The commit/PR message to use when updating all the repositories."
    required: false
    default: "Bump repositories to their latest version"
  add_repos:
    description: "Runs the `fetch-repos` script if enabled to clone all the repositories."
    required: true
    default: "false"
  update_repos:
    description: "Whether to update the repositories or not."
    required: true
    default: "true"
  squash_commits:
    description: "Whether to squash all commits into one or not."
    required: false
    default: "false"
  one_pr:
    description: "Creates one single PR for updating all the repositories. This does not apply to the `fetch-repos` script. `squash_commits` must be disabled!"
    required: false
    default: "false"
runs:
  using: "composite"
  steps:
    - name: Make sure the configuration is valid
      shell: bash
      run: |
        if [[ ${{ inputs.add_repos }} == false ]] && [[ ${{ inputs.update_repos }} == false ]]; then
          echo "Both 'add_repos' and 'update_repos' are disabled. Please enable at least one of them."
          exit 1
        fi
    - name: Setup Git configurations
      shell: bash
      run: |
        git config --global user.name github-actions[bot]
        git config --global user.email 'github-actions@users.noreply.github.com'
    - name: Change to the correct branch
      shell: bash
      run: |
        if git ls-remote --heads origin ${{ inputs.branch_name }} | grep -q ${{ inputs.branch_name }}; then
          git checkout ${{ inputs.branch_name }}
        else
          git checkout -b ${{ inputs.branch_name }}
        fi
    - name: Update the repositories file
      shell: bash
      run: |
        if [[ $(git diff --name-only origin/${GITHUB_REF##*/} ${{ inputs.repos_filename }}.lua) ]]; then
          git rm ${{ inputs.repos_filename }}.lua || true

          default_branch=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          wget https://raw.githubusercontent.com/${{ github.repository }}/${default_branch}/${{ inputs.repos_filename }}.lua

          if [[ $(git diff --name-only) ]]; then
            git add ${{ inputs.repos_filename }}.lua
            git commit -m 'Update repositories file'
          fi
        fi
    - name: Setup Lua
      uses: xpol/setup-lua@master
      with:
        lua-version: "5.3.3"
    - name: Fetch scripts
      shell: bash
      run: |
        wget https://raw.githubusercontent.com/Panquesito7/submodules-alternative/main/helper-functions.lua

        if [[ ${{ inputs.add_repos }} == true ]]; then
          # Committing is necessary if we want to revert the changes and fetching
          # the script at the same time, as otherwise, the scriptS below would fail.
          if [[ ! -f fetch-repos.lua ]]; then
            wget https://raw.githubusercontent.com/Panquesito7/submodules-alternative/main/fetch-repos.lua
            git add fetch-repos.lua
            git commit -m "Get the fetch-repos script"
          fi
        fi

        if [[ ${{ inputs.update_repos }} == true ]]; then
          if [[ ! -f update-repos.lua ]]; then
            wget https://raw.githubusercontent.com/Panquesito7/submodules-alternative/main/update-repos.lua
            git add update-repos.lua
            git commit -m "Get the update-repos script"
          fi
        fi
    - name: Clone repositories
      shell: bash
      run: |
        if [[ ${{ inputs.add_repos }} == true ]]; then
          lua fetch-repos.lua ${{ inputs.repos_filename }} ${{ inputs.squash_commits }} ${{ inputs.commit_message }}
        fi
    - name: Update repositories
      shell: bash
      run: |
        if [[ ${{ inputs.update_repos }} == true ]]; then
          lua update-repos.lua ${{ inputs.repos_filename }} "${{ inputs.commit_message_update }}" ${{ inputs.squash_commits }} ${{ inputs.one_pr }}
        fi
    - name: Push changes and create PR
      shell: bash
      run: |
        # Removes the `fetch-repos.lua` script from the repository, as it is not needed.
        if [[ ${{ inputs.add_repos }} == true ]]; then
          git revert $(git log --branches --not --remotes --grep 'Get the fetch-repos script' --oneline | cut -d' ' -f1) --no-edit || true
        fi

        # Removes the `update-repos.lua` script from the repository, as it is not needed.
        if [[ ${{ inputs.update_repos }} == true ]]; then
          git revert $(git log --branches --not --remotes --grep 'Get the update-repos script' --oneline | cut -d' ' -f1) --no-edit || true
        fi

        if [[ ${{ inputs.use_pr }} == true ]]; then
          if [[ ${{ inputs.one_pr }} == true ]]; then
            git push origin ${{ inputs.branch_name }}:${{ inputs.branch_name }} || true
            gh pr create --base ${GITHUB_REF##*/} --head ${{ inputs.branch_name }} --title '${{ inputs.commit_message }}' --body 'Repositories were added or updated using the Submodules Alternative tool.' || true
          else
            # The One PR option is not available when adding the repositories.
            if [[ ${{ inputs.add_repos }} == true ]]; then
              git checkout ${{ inputs.branch_name }} || true

              git push origin ${{ inputs.branch_name }}:${{ inputs.branch_name }} || true
              gh pr create --base ${GITHUB_REF##*/} --head ${{ inputs.branch_name }} --title '${{ inputs.commit_message }}' --body 'Repositories were added or updated using the Submodules Alternative tool.' || true
            else # The `add_repos` option is disabled.
              branches=$(lua -e 'local repos = require("${{ inputs.repos_filename }}").repos; dofile("helper-functions.lua"); get_repo_branches(repos)')

              for branch in ${branches[@]}; do
                repo_name=${branch%-update}
                gh pr create --base ${GITHUB_REF##*/} --head $branch --title 'Bump $repo_name to its latest commit' --body 'The repository $repo_name was updated to its latest commit.' || true
              done
            fi
          fi
        else
          git push || true
        fi
      env:
        GH_TOKEN: ${{ github.token }}
